-- SasaArt Supabase Setup Script (v3 - Clean)

-- 1. CREATE TABLES
-- This section creates the necessary tables to store your portfolio data.

-- Create a table for main categories (Art, Music, Literature, Architecture)
CREATE TABLE public.categories (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  created_at TIMESTAMPTZ DEFAULT now() NOT NULL,
  name TEXT NOT NULL UNIQUE,
  slug TEXT NOT NULL UNIQUE
);
COMMENT ON TABLE public.categories IS 'Stores the main categories of creative work.';

-- Create a table for sub-categories (e.g., Canvas, Poetry, Original Songs)
CREATE TABLE public.subcategories (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  created_at TIMESTAMPTZ DEFAULT now() NOT NULL,
  name TEXT NOT NULL,
  slug TEXT NOT NULL,
  category_id UUID REFERENCES public.categories(id) ON DELETE CASCADE NOT NULL,
  UNIQUE(slug, category_id) -- A slug should be unique within its parent category
);
COMMENT ON TABLE public.subcategories IS 'Stores sub-categories within main categories.';

-- Create the main table for all portfolio projects
CREATE TABLE public.projects (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  created_at TIMESTAMPTZ DEFAULT now() NOT NULL, -- This handles the automatic timestamp for blog-like posts
  title TEXT NOT NULL,
  content TEXT, -- For Literature/blog content
  image_url TEXT, -- For Art, Literature, Architecture images
  soundcloud_url TEXT, -- For Music links
  category_id UUID REFERENCES public.categories(id) ON DELETE RESTRICT NOT NULL,
  subcategory_id UUID REFERENCES public.subcategories(id) ON DELETE SET NULL
);
COMMENT ON TABLE public.projects IS 'Stores all individual portfolio projects across all categories.';


-- 2. CREATE STORAGE BUCKET
-- This creates a dedicated place to upload and store images for your projects.
INSERT INTO storage.buckets (id, name, public)
VALUES ('project_images', 'project_images', false)
ON CONFLICT (id) DO NOTHING;


-- 3. ENABLE ROW LEVEL SECURITY (RLS)
-- Ensures that no data can be accessed unless a policy grants permission.
ALTER TABLE public.categories ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.subcategories ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.projects ENABLE ROW LEVEL SECURITY;


-- 4. CREATE RLS POLICIES FOR DATA TABLES
-- These policies define who can do what with your data.

-- POLICIES FOR `categories`
CREATE POLICY "Allow public read access to categories" ON public.categories
  FOR SELECT USING (true);
CREATE POLICY "Allow admin to insert categories" ON public.categories
  FOR INSERT WITH CHECK (auth.role() = 'authenticated');
CREATE POLICY "Allow admin to update categories" ON public.categories
  FOR UPDATE USING (auth.role() = 'authenticated');
CREATE POLICY "Allow admin to delete categories" ON public.categories
  FOR DELETE USING (auth.role() = 'authenticated');

-- POLICIES FOR `subcategories`
CREATE POLICY "Allow public read access to subcategories" ON public.subcategories
  FOR SELECT USING (true);
CREATE POLICY "Allow admin to insert subcategories" ON public.subcategories
  FOR INSERT WITH CHECK (auth.role() = 'authenticated');
CREATE POLICY "Allow admin to update subcategories" ON public.subcategories
  FOR UPDATE USING (auth.role() = 'authenticated');
CREATE POLICY "Allow admin to delete subcategories" ON public.subcategories
  FOR DELETE USING (auth.role() = 'authenticated');

-- POLICIES FOR `projects`
CREATE POLICY "Allow public read access to projects" ON public.projects
  FOR SELECT USING (true);
CREATE POLICY "Allow admin to insert projects" ON public.projects
  FOR INSERT WITH CHECK (auth.role() = 'authenticated');
CREATE POLICY "Allow admin to update projects" ON public.projects
  FOR UPDATE USING (auth.role() = 'authenticated');
CREATE POLICY "Allow admin to delete projects" ON public.projects
  FOR DELETE USING (auth.role() = 'authenticated');


-- 5. CREATE POLICIES FOR STORAGE (`project_images` bucket)
-- These policies control who can view, upload, update, or delete images.

CREATE POLICY "Allow public read access to project images" ON storage.objects
  FOR SELECT USING (bucket_id = 'project_images');

CREATE POLICY "Allow admin to upload project images" ON storage.objects
  FOR INSERT WITH CHECK (bucket_id = 'project_images' AND auth.role() = 'authenticated');

CREATE POLICY "Allow admin to update project images" ON storage.objects
  FOR UPDATE USING (auth.uid() = owner AND bucket_id = 'project_images');

CREATE POLICY "Allow admin to delete project images" ON storage.objects
  FOR DELETE USING (auth.uid() = owner AND bucket_id = 'project_images');

